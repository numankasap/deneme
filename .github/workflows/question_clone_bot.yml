# Question Clone Bot Workflow
# ============================
# FotoÄŸraftan benzer soru Ã¼retici
#
# AkÄ±ÅŸ:
# 1. question_templates tablosundaki fotoÄŸraflarÄ± al
# 2. Gemini Vision ile analiz et
# 3. Benzer ama farklÄ± sorular Ã¼ret
# 4. GÃ¶rselleri Gemini Image ile Ã§iz
# 5. question_bank'a kaydet

name: Question Clone Bot

on:
  # Manuel tetikleme
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Ä°ÅŸlenecek ÅŸablon sayÄ±sÄ±'
        required: false
        default: '3'
        type: string
      variations:
        description: 'Her ÅŸablondan Ã¼retilecek varyasyon sayÄ±sÄ±'
        required: false
        default: '3'
        type: string
      test_mode:
        description: 'Test modu (1 ÅŸablon, 1 varyasyon)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
          
  # GÃ¼nlÃ¼k Ã§alÄ±ÅŸma (isteÄŸe baÄŸlÄ±)
  # schedule:
  #   - cron: '0 6 * * *'  # Her gÃ¼n 09:00 TR

jobs:
  generate-questions:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: question_clone_requirements.txt
      
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r question_clone_requirements.txt
      
      - name: ðŸ¤– Run Question Clone Bot
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          BATCH_SIZE: ${{ github.event.inputs.test_mode == 'true' && '1' || github.event.inputs.batch_size || '3' }}
          VARIATIONS: ${{ github.event.inputs.test_mode == 'true' && '1' || github.event.inputs.variations || '3' }}
          QUALITY_THRESHOLD: '7'
          MAX_RETRIES: '3'
        run: |
          echo "ðŸ¤– Question Clone Bot BaÅŸlatÄ±lÄ±yor..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“… Tarih: $(date)"
          echo "ðŸ“Š Batch Size: $BATCH_SIZE ÅŸablon"
          echo "ðŸ”„ Varyasyonlar: $VARIATIONS / ÅŸablon"
          echo "ðŸ” Kalite KontrolÃ¼: Gemini (threshold: $QUALITY_THRESHOLD)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          python question_clone_bot.py
      
      - name: ðŸ“Š Job Summary
        if: always()
        run: |
          echo "## ðŸ¤– Question Clone Bot SonuÃ§larÄ±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parametre | DeÄŸer |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“… Tarih | $(date) |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Batch Size | ${{ github.event.inputs.batch_size || '3' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”„ Varyasyonlar | ${{ github.event.inputs.variations || '3' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### NasÄ±l KullanÄ±lÄ±r" >> $GITHUB_STEP_SUMMARY
          echo "1. BeÄŸendiÄŸin soru fotoÄŸrafÄ±nÄ± \`question_templates\` tablosuna ekle" >> $GITHUB_STEP_SUMMARY
          echo "2. Bu workflow'u Ã§alÄ±ÅŸtÄ±r" >> $GITHUB_STEP_SUMMARY
          echo "3. Bot her fotoÄŸraftan 3 benzer soru Ã¼retir" >> $GITHUB_STEP_SUMMARY
