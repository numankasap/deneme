name: AYT Fizik Soru Uretim Botu

on:
  # Manuel tetikleme
  workflow_dispatch:
    inputs:
      mode:
        description: 'Calisma modu'
        required: true
        default: 'batch'
        type: choice
        options:
          - batch
          - topic
          - single
      count:
        description: 'Soru sayisi (batch/topic icin)'
        required: false
        default: '1'
        type: string
      topic:
        description: 'Konu (topic/single modu icin)'
        required: false
        default: 'hareket_ve_kuvvet'
        type: choice
        options:
          - hareket_ve_kuvvet
          - tork_ve_denge
          - dairesel_hareket
          - basit_harmonik_hareket
          - elektrostatik
          - manyetizma
          - alternatif_akim
          - dalgalar
          - elektromanyetik_dalgalar
          - ozel_gorelilik
          - kuantum_fizigi
          - atom_fizigi
          - standart_model
          - tibbi_goruntuleme
          - superleitkenlik
      bloom:
        description: 'Bloom seviyesi (single modu icin)'
        required: false
        default: 'Analiz'
        type: choice
        options:
          - Uygulama
          - Analiz
          - Degerlendirme
          - Yaratma
      zorluk:
        description: 'Zorluk seviyesi 1-5 (single modu icin)'
        required: false
        default: '4'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'

  # Zamanlanmis calisma - Her gun saat 06:00 ve 18:00 (UTC)
  schedule:
    - cron: '0 6 * * *'   # Her gun 06:00 UTC (09:00 TR)
    - cron: '0 18 * * *'  # Her gun 18:00 UTC (21:00 TR)

env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_KEY }}

jobs:
  generate-questions:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify environment
        run: |
          echo "=== Environment Check ==="
          python --version
          pip list | grep -E "(google-genai|requests)"
          echo "SUPABASE_URL is set: ${{ secrets.SUPABASE_URL != '' }}"
          echo "GEMINI_API_KEY is set: ${{ secrets.GEMINI_API_KEY != '' }}"
          echo "SUPABASE_KEY is set: ${{ secrets.SUPABASE_KEY != '' }}"

      - name: Run AYT Fizik Bot (Manual)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "=== Manual Run ==="
          echo "Mode: ${{ github.event.inputs.mode }}"
          echo "Count: ${{ github.event.inputs.count }}"
          echo "Topic: ${{ github.event.inputs.topic }}"
          echo "Bloom: ${{ github.event.inputs.bloom }}"
          echo "Zorluk: ${{ github.event.inputs.zorluk }}"
          
          if [ "${{ github.event.inputs.mode }}" == "batch" ]; then
            python ayt_fizik_bot.py --mode batch --count ${{ github.event.inputs.count }}
          elif [ "${{ github.event.inputs.mode }}" == "topic" ]; then
            python ayt_fizik_bot.py --mode topic --topic ${{ github.event.inputs.topic }} --count ${{ github.event.inputs.count }}
          elif [ "${{ github.event.inputs.mode }}" == "single" ]; then
            python ayt_fizik_bot.py --mode single --konu ${{ github.event.inputs.topic }} --bloom ${{ github.event.inputs.bloom }} --zorluk ${{ github.event.inputs.zorluk }}
          fi

      - name: Run AYT Fizik Bot (Scheduled)
        if: github.event_name == 'schedule'
        run: |
          echo "=== Scheduled Run ==="
          echo "Generating 1 question per topic..."
          python ayt_fizik_bot.py --mode batch --count 1

      - name: Summary
        if: always()
        run: |
          echo "=== Job Summary ==="
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Event: ${{ github.event_name }}"
          echo "Status: ${{ job.status }}"
          echo "Completed at: $(date)"
