name: 10. Sinif Fizik Tema 1 - Soru Uretim Botu v2.0

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Calisma modu'
        required: true
        default: 'batch'
        type: choice
        options:
          - batch
          - topic
          - single
      count:
        description: 'Soru sayisi (batch/topic icin)'
        required: false
        default: '30'
        type: string
      topic:
        description: 'Konu (topic/single modu icin)'
        required: false
        default: 'sabit_hizli_hareket'
        type: choice
        options:
          - sabit_hizli_hareket
          - ivmeli_hareket
          - serbest_dusme
          - iki_boyutta_hareket
      soru_tipi:
        description: 'Soru tipi (single modu icin)'
        required: false
        default: 'hikayeli'
        type: choice
        options:
          - hikayeli
          - grafik
          - onculu
          - hesaplama
          - karsilastirma
          - analiz
      bloom:
        description: 'Bloom seviyesi (single modu icin)'
        required: false
        default: 'Uygulama'
        type: choice
        options:
          - Hatirlama
          - Anlama
          - Uygulama
          - Analiz
          - Degerlendirme
          - Yaratma
      zorluk:
        description: 'Zorluk seviyesi 1-6 (single modu icin)'
        required: false
        default: '3'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'
          - '6'

  schedule:
    - cron: '0 7 * * *'
    - cron: '0 19 * * *'

env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_KEY }}

jobs:
  generate-questions:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify environment
        run: |
          echo "=== Environment Check ==="
          python --version
          pip list | grep -E "(google-genai|requests)"
          echo "SUPABASE_URL is set: ${{ secrets.SUPABASE_URL != '' }}"
          echo "GEMINI_API_KEY is set: ${{ secrets.GEMINI_API_KEY != '' }}"
          echo "SUPABASE_KEY is set: ${{ secrets.SUPABASE_KEY != '' }}"

      - name: Run Fizik10 Tema1 Bot v2.0 (Manual)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "=== Manual Run (v2.0) ==="
          echo "Mode: ${{ github.event.inputs.mode }}"
          echo "Count: ${{ github.event.inputs.count }}"
          echo "Topic: ${{ github.event.inputs.topic }}"
          echo "Soru Tipi: ${{ github.event.inputs.soru_tipi }}"
          echo "Bloom: ${{ github.event.inputs.bloom }}"
          echo "Zorluk: ${{ github.event.inputs.zorluk }}"

          if [ "${{ github.event.inputs.mode }}" == "batch" ]; then
            python fizik10_tema1_bot.py --mode batch --count ${{ github.event.inputs.count }}
          elif [ "${{ github.event.inputs.mode }}" == "topic" ]; then
            python fizik10_tema1_bot.py --mode topic --topic ${{ github.event.inputs.topic }} --count ${{ github.event.inputs.count }}
          elif [ "${{ github.event.inputs.mode }}" == "single" ]; then
            python fizik10_tema1_bot.py --mode single --topic ${{ github.event.inputs.topic }} --bloom ${{ github.event.inputs.bloom }} --zorluk ${{ github.event.inputs.zorluk }}
          fi

      - name: Run Fizik10 Tema1 Bot v2.0 (Scheduled)
        if: github.event_name == 'schedule'
        run: |
          echo "=== Scheduled Run (v2.0) ==="
          echo "Bloom Taksonomisi dagilimi aktif (6 seviye)"
          echo "Maarif Modeli kriterleri aktif"
          python fizik10_tema1_bot.py --mode batch --count 30

      - name: Summary
        if: always()
        run: |
          echo "=== Job Summary ==="
          echo "Bot: 10. Sinif Fizik - Tema 1: Bir Boyutta Hareket"
          echo "Bot Version: v2.0"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Event: ${{ github.event_name }}"
          echo "Status: ${{ job.status }}"
          echo "Completed at: $(date)"
