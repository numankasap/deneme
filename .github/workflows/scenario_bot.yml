# Scenario Bot v2.0 Workflow
# PISA ve senaryo tabanlÄ± sorular iÃ§in:
# - Tablo/veri iÃ§eren sorularda infografik gÃ¶rsel Ã¼retir
# - Soru metnini sadeleÅŸtirir (tablo/veri kÄ±smÄ±nÄ± Ã§Ä±karÄ±r)
# - Gemini ile kalite kontrolÃ¼ yapar
# - Onay gelirse veritabanÄ±nÄ± gÃ¼nceller
#
# GÃ¼nde 3 kez Ã§alÄ±ÅŸÄ±r (09:00, 15:00, 21:00 UTC+3)
# Her seansta 30 soru iÅŸler, test modunda 10 soru

name: Scenario Bot v2

on:
  # Manuel tetikleme
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test modu (10 soru)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      batch_size:
        description: 'Ä°ÅŸlenecek soru sayÄ±sÄ± (1-100)'
        required: false
        default: '30'
        type: string
      quality_threshold:
        description: 'Kalite eÅŸiÄŸi (1-10)'
        required: false
        default: '7'
        type: string
  
  # ZamanlanmÄ±ÅŸ Ã§alÄ±ÅŸma (Geometri botundan 1 saat sonra)
  schedule:
    # 06:00 UTC = 09:00 TR
    - cron: '0 6 * * *'
    # 12:00 UTC = 15:00 TR
    - cron: '0 12 * * *'
    # 18:00 UTC = 21:00 TR
    - cron: '0 18 * * *'

jobs:
  generate-scenario-visuals:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scenario_requirements.txt
      
      - name: ðŸŽ­ Install Playwright browsers
        run: |
          playwright install chromium
          playwright install-deps chromium
      
      - name: ðŸ–¼ï¸ Run Scenario Bot v2
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TEST_MODE: ${{ github.event.inputs.test_mode || 'false' }}
          BATCH_SIZE: ${{ github.event.inputs.batch_size || '30' }}
          QUALITY_THRESHOLD: ${{ github.event.inputs.quality_threshold || '7' }}
        run: |
          echo "ðŸš€ Senaryo GÃ¶rsel Botu v2.0 BaÅŸlatÄ±lÄ±yor..."
          echo "ðŸ“… Tarih: $(date)"
          echo "ðŸ”§ Test Modu: $TEST_MODE"
          echo "ðŸ“Š Batch Boyutu: $BATCH_SIZE soru"
          echo "â­ Kalite EÅŸiÄŸi: $QUALITY_THRESHOLD/10"
          echo ""
          echo "ðŸ“‹ Yeni Ã–zellikler:"
          echo "   - Tablo/veri iÃ§eren sorulara gÃ¶rsel oluÅŸturma"
          echo "   - Soru metni sadeleÅŸtirme (veri â†’ gÃ¶rsel)"
          echo "   - Gemini ile kalite kontrolÃ¼ ve puanlama"
          echo ""
          python scenario_bot.py
      
      - name: ðŸ“Š Job Summary
        if: always()
        run: |
          echo "## ðŸ–¼ï¸ Senaryo Bot v2.0 Ã‡alÄ±ÅŸmasÄ± TamamlandÄ±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš™ï¸ Ayarlar" >> $GITHUB_STEP_SUMMARY
          echo "| Parametre | DeÄŸer |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tarih | $(date) |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Modu | ${{ github.event.inputs.test_mode || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Batch Boyutu | ${{ github.event.inputs.batch_size || '30' }} soru |" >> $GITHUB_STEP_SUMMARY
          echo "| Kalite EÅŸiÄŸi | ${{ github.event.inputs.quality_threshold || '7' }}/10 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ†• v2.0 Ã–zellikleri" >> $GITHUB_STEP_SUMMARY
          echo "- âœ¨ Tablo/veri iÃ§eren sorulara otomatik gÃ¶rsel" >> $GITHUB_STEP_SUMMARY
          echo "- âœ‚ï¸ Soru metni sadeleÅŸtirme (veri gÃ¶rsele taÅŸÄ±nÄ±r)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ¯ Gemini ile kalite kontrolÃ¼ ve puanlama" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ VeritabanÄ±nda hem gÃ¶rsel hem metin gÃ¼ncelleme" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Detaylar iÃ§in loglarÄ± kontrol edin." >> $GITHUB_STEP_SUMMARY
