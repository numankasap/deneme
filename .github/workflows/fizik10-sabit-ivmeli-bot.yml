name: 10. Sinif Fizik - Sabit Ivmeli Hareket Ozel Botu

on:
  workflow_dispatch:
    inputs:
      mod:
        description: 'Calisma modu'
        required: true
        default: 'karisik'
        type: choice
        options:
          - karisik
          - kazanim
          - baglam
      tip:
        description: 'Soru tipi'
        required: false
        default: 'karisik'
        type: choice
        options:
          - karisik
          - hesaplama
          - grafik
          - onculu
      adet:
        description: 'Soru sayisi'
        required: false
        default: '20'
        type: string
      gorsel:
        description: 'Gorsel uretimi'
        required: false
        default: 'hayir'
        type: choice
        options:
          - hayir
          - evet
      kazanim:
        description: 'Kazanim (kazanim modu icin)'
        required: false
        default: 'tumu'
        type: choice
        options:
          - tumu
          - FIZ.10.1.2.a
          - FIZ.10.1.2.b
          - FIZ.10.1.3.a
          - FIZ.10.1.3.b
          - FIZ.10.1.3.c
      bloom:
        description: 'Bloom seviyesi'
        required: false
        default: 'Uygulama'
        type: choice
        options:
          - Hatirlama
          - Anlama
          - Uygulama
          - Analiz
          - DeÄŸerlendirme
          - Yaratma

  schedule:
    - cron: '08 * * 1,3,5'
    - cron: '0 20 * * 2,4,6'

env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_KEY }}

jobs:
  generate-questions:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: fizik10_sabit_ivmeli_requirements.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r fizik10_sabit_ivmeli_requirements.txt

      - name: Verify environment
        run: |
          echo "=== Environment Check ==="
          python --version
          pip list | grep -E "(google-genai|requests)"
          echo "SUPABASE_URL is set: ${{ secrets.SUPABASE_URL != '' }}"
          echo "GEMINI_API_KEY is set: ${{ secrets.GEMINI_API_KEY != '' }}"
          echo "SUPABASE_KEY is set: ${{ secrets.SUPABASE_KEY != '' }}"

      - name: Run Sabit Ivmeli Hareket Bot (Manual)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "=== Manual Run - Sabit Ivmeli Hareket Botu ==="
          echo "Mod: ${{ github.event.inputs.mod }}"
          echo "Tip: ${{ github.event.inputs.tip }}"
          echo "Adet: ${{ github.event.inputs.adet }}"
          echo "Gorsel: ${{ github.event.inputs.gorsel }}"
          echo "Kazanim: ${{ github.event.inputs.kazanim }}"
          echo "Bloom: ${{ github.event.inputs.bloom }}"

          # Build command
          CMD="python fizik10_sabit_ivmeli_bot.py --mod ${{ github.event.inputs.mod }} --adet ${{ github.event.inputs.adet }} --tip ${{ github.event.inputs.tip }}"

          # Add gorsel flag if enabled
          if [ "${{ github.event.inputs.gorsel }}" == "evet" ]; then
            CMD="$CMD --gorsel"
          fi

          # Add kazanim filter for kazanim mode
          if [ "${{ github.event.inputs.mod }}" == "kazanim" ] && [ "${{ github.event.inputs.kazanim }}" != "tumu" ]; then
            CMD="$CMD --kazanim ${{ github.event.inputs.kazanim }}"
          fi

          # Add bloom
          if [ "${{ github.event.inputs.bloom }}" != "Uygulama" ]; then
            CMD="$CMD --bloom ${{ github.event.inputs.bloom }}"
          fi

          echo "Command: $CMD"
          eval $CMD

      - name: Run Sabit Ivmeli Hareket Bot (Scheduled)
        if: github.event_name == 'schedule'
        run: |
          echo "=== Scheduled Run - Sabit Ivmeli Hareket Botu ==="
          echo "Dengeli dagilim: Hesaplama + Grafik + Onculu"
          echo "Maarif Modeli kriterleri aktif"
          echo "Bloom Taksonomisi dagilimi aktif"

          HOUR=$(date +%H)
          DAY=$(date +%u)

          # Pazartesi, Carsamba, Cuma sabah: Hesaplama agirlikli
          # Sali, Persembe, Cumartesi aksam: Baglam + onculu agirlikli
          if [ "$HOUR" -lt 12 ]; then
            echo "Sabah calismasi: Kazanim temelli, hesaplama agirlikli"
            python fizik10_sabit_ivmeli_bot.py --mod kazanim --adet 15 --tip hesaplama --gorsel
          else
            echo "Aksam calismasi: Baglam temelli, karisik tip"
            python fizik10_sabit_ivmeli_bot.py --mod baglam --adet 15 --tip karisik --gorsel
          fi

      - name: Summary
        if: always()
        run: |
          echo "=== Job Summary ==="
          echo "Bot: Sabit Ivmeli Hareket Ozel Botu"
          echo "Konu: Bir Boyutta Sabit Ivmeli Hareket"
          echo "Kazanimlar: FIZ.10.1.2.a-b, FIZ.10.1.3.a-c"
          echo "Soru Tipleri: hesaplama, grafik, onculu"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Event: ${{ github.event_name }}"
          echo "Status: ${{ job.status }}"
          echo "Completed at: $(date)"
